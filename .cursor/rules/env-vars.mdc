---
description: How environment variables flow through the app
globs:
alwaysApply: false
---

## Astro configuration

Define new variables in `apps/web/astro.config.ts` using the built-in `envField` helpers. Match the access pattern used today:

```ts
// apps/web/astro.config.ts
env: {
  schema: {
    SITE_BASE_URL: envField.string({ context: 'client', access: 'public' }),
    DATABASE_URL: envField.string({ context: 'server', access: 'secret' }),
    // ...add new fields here
  },
},
```

Use `context: 'server'` for secrets and `context: 'client'` for values needed in the browser. Public values (`access: 'public'`) are safe to expose client side; secrets stay server only.

## Passing env into tRPC

1. Extend the `Env` interface in `packages/api/src/context.ts` when a router needs additional values.
   ```ts
   export interface Env {
     siteBaseUrl: string
     githubAppId: string
     githubAppPrivateKey: string
     githubWebhookSecret: string
     openRouterApiKey: string
     databaseUrl: string
     triggerSecretKey: string
     // add new fields here
   }
   ```
2. Map Astro env values to that shape in `apps/web/src/server/env.ts`:
   ```ts
   import { SITE_BASE_URL } from 'astro:env/client'
   import { DATABASE_URL } from 'astro:env/server'

   export const env: Env = {
     siteBaseUrl: SITE_BASE_URL,
     databaseUrl: DATABASE_URL,
     // ...
   }
   ```
3. The tRPC handler (`apps/web/src/pages/api/trpc/[trpc].ts`) already injects this `env` object into the context it returns. Routers access values via `ctx.env`.

## Build & CI

- Add new build-time env vars to the `env` array for relevant tasks in `turbo.json` so Turborepo caches correctly.
- Update CI configuration (e.g. GitHub Actions secrets) when introducing required secrets.
