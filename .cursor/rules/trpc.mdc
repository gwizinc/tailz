---
description: How tRPC is wired into the app
globs:
alwaysApply: false
---

The web app uses tRPC with `@tanstack/react-query` via the helpers exported from `apps/web/src/client/trpc.ts`.

## Client usage

- Wrap interactive routes in `<TRPCProvider>` (see `apps/web/src/components/providers/app-provider.tsx`).
- Obtain the client with `const trpc = useTRPCClient()` inside React components.
- Call routers directly with `.query`, `.mutate`, or `.subscribe` and manage loading/error state locally (most loaders use `useEffect` + `useState`).
- For background refresh, reuse existing helpers like `useSmartPolling` (`apps/web/src/hooks/use-smart-polling.ts`).

## Server usage

- The Astro API route at `apps/web/src/pages/api/trpc/[trpc].ts` constructs the tRPC context by combining:
  - the database instance from `@/server/db`
  - the Better Auth session (see `@/server/auth`)
  - the typed env object from `@/server/env`
- tRPC routers live in `packages/api/src/routers`. Add new procedures there and export the router through `packages/api/src/index.ts`.

## Patterns to follow

- Parse request/response shapes with Zod inside the router procedures (see `packages/api/src/routers/repo.ts`).
- Keep the frontend components thin: let routers perform data fetching, filtering, and mutations.
- If a component needs to share logic across multiple places, extract a small hook alongside the component rather than duplicating fetch calls.
